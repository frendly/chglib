# Отчет о проблемах разметки HTML в pages/LEGACY_BNP

**Дата создания**: 2025-01-27  
**Директория**: `pages/LEGACY_BNP/`  
**Общее количество HTML файлов**: ~322 файла

## Резюме

Обнаружено несколько категорий проблем разметки HTML, которые могут вызвать проблемы при конвертации в Markdown:

1. **Закрывающие теги `</font>` без открывающих тегов** - 249 файлов
2. **Некорректные пути в атрибутах href** - 1 файл
3. **Пустые теги** - 1 файл
4. **Некорректный закрывающий тег `</br>`** - 1 файл
5. **URL с некорректным кодированием пробелов** - 9 случаев в 1 файле

---

## 1. Закрывающие теги `</font>` без открывающих тегов

### Описание проблемы

В конце многих файлов присутствуют закрывающие теги `</font>`, но отсутствуют соответствующие открывающие теги `<font>`. Это создает некорректную структуру HTML.

### Масштаб проблемы

**Всего затронуто**: 249 файлов (322 совпадения, включая правильные использования)

**Распределение по годам**:

- **2012**: 47 файлов
- **2013**: 40 файлов  
- **2014**: 29 файлов
- **2015**: 26 файлов
- **2016**: 25 файлов
- **2017**: 24 файла
- **2018**: 27 файлов
- **2019**: 24 файла
- **2020**: 13 файлов
- **2021**: 6 файлов (5 с проблемой, 1 с правильными тегами)

**2022-2025**: Проблем не обнаружено

---

## Проверка разметки через html-validate

Для автоматической проверки HTML-файлов в `pages/LEGACY_BNP/` добавлен валидатор `html-validate`.

- **Запуск проверки только для LEGACY_BNP**:

  ```bash
  yarn html-validate:legacy-bnp
  ```

- **Что делает команда**:
  - запускает `html-validate` для всех файлов по маске `pages/LEGACY_BNP/**/*.html`;
  - использует базовый пресет правил `html-validate:recommended` с небольшими послаблениями:
    - правило `doctype-style` отключено;
    - правило `no-inline-style` понижено до предупреждений;
    - правило `no-trailing-whitespace` включено как предупреждение.

- **Интерпретация результата**:
  - сообщения уровня `error` означают, что разметка формально невалидна и требует правки;
  - сообщения уровня `warning` (например, `no-trailing-whitespace`) можно постепенно устранять по мере работы над файлом;
  - ненулевой код выхода команды (exit code 1) означает, что найдены ошибки или предупреждения — это ожидаемо для текущего состояния LEGACY-разметки.

Рекомендуемый рабочий процесс:

1. Выполнить массовые механические правки (регулярные выражения, перекодировка в UTF‑8 и т.п.), описанные выше в этом документе.
2. Запускать `yarn html-validate:legacy-bnp` для выявления оставшихся структурных ошибок (непарные теги, некорректные атрибуты и т.д.).
3. По мере очистки файлов постепенно снижать количество предупреждений и ошибок, ориентируясь на отчёт `html-validate`.

### Примеры проблемных файлов

#### Пример 1: `2012/bnp01.html` (строка 59)
```html
  25.<b>Trends in Biochemical Sciences.</b> -2011.-Vol.36, N 6.
</font>
```

#### Пример 2: `2015/bnp01.html` (строка 282)
```html
  27.<b>Известия РАН. Сер. Физическая.</b> -2014.-Т.78, N 11.
  <span class="content-link">Содержание</span>
  <span class="content">
    <a href="jpg01/IzvRANserFiz_1354-1430.jpg"></a>
    <a href="jpg01/IzvRANserFiz_1432-1506.jpg"></a>
  </span>
  
</font>
```

#### Пример 3: `2020/bnp01.html` (строка 65)
```html
  4.<b>Известия РАН. Сер. Физика атмосферы и океана.</b> -2019.-Т. 55, № 3.
  <a href="/BNP/2020/pdf01/ИзвРАНсерФизАтмОк-2019-55(3).pdf">Содержание</a>
  

</font>
```

### Исключения (правильное использование)

#### `2021/bnp09.html` (строки 8, 22)
```html
<font color=maroon> представлена для ознакомления (не из фонда БНЦ) </font>
```

Этот файл содержит правильно закрытые теги `<font>` с атрибутом `color`.

### Полный список затронутых файлов

#### 2012 (47 файлов)
- `bnp01.html` - строка 59
- `bnp02.html` - строка 94
- `bnp03.html` - строка 127
- `bnp04.html` - строка 96
- `bnp05.html` - строка 132
- `bnp06.html` - строка 193
- `bnp07.html` - строка 212
- `bnp08.html` - строка 213
- `bnp09.html` - строка 151
- `bnp10.html` - строка 166
- `bnp11.html` - строка 184
- `bnp12.html` - строка 139
- `bnp13.html` - строка 218
- `bnp14.html` - строка 166
- `bnp15.html` - строка 134
- `bnp16.html` - строка 156
- `bnp17.html` - строка 287
- `bnp18.html` - строка 174
- `bnp19.html` - строка 169
- `bnp20.html` - строка 144
- `bnp21.html` - строка 177
- `bnp22.html` - строка 236
- `bnp23.html` - строка 181
- `bnp24.html` - строка 138
- `bnp25.html` - строка 154
- `bnp26.html` - строка 94
- `bnp27.html` - строка 252
- `bnp28.html` - строка 247
- `bnp29.html` - строка 258
- `bnp30.html` - строка 150
- `bnp31.html` - строка 261
- `bnp32.html` - строка 351
- `bnp33.html` - строка 257
- `bnp34.html` - строка 259
- `bnp35.html` - строка 281
- `bnp36.html` - строка 518
- `bnp37.html` - строка 269
- `bnp38.html` - (если есть)
- `bnp39.html` - строка 359
- `bnp40.html` - строка 257
- `bnp41.html` - строка 202
- `bnp42.html` - (если есть)
- `bnp43.html` - строка 325
- `bnp44.html` - строка 224
- `bnp45.html` - строка 145

#### 2013 (40 файлов)
- Все файлы `bnp01.html` - `bnp40.html` (кроме отсутствующих)

#### 2014 (29 файлов)
- Все файлы `bnp02.html` - `bnp27.html` (кроме отсутствующих)

#### 2015 (26 файлов)
- Все файлы `bnp01.html` - `bnp25.html` (кроме отсутствующих)

#### 2016 (25 файлов)
- Все файлы `bnp01.html` - `bnp25.html`

#### 2017 (24 файла)
- Все файлы `bnp01.html` - `bnp23.html` (кроме отсутствующих)

#### 2018 (27 файлов)
- Все файлы `bnp01.html` - `bnp26.html` (кроме отсутствующих)

#### 2019 (24 файла)
- Все файлы `bnp01.html` - `bnp23.html` (кроме отсутствующих)

#### 2020 (13 файлов)
- `bnp01.html` - строка 65
- `bnp02.html` - строка 82
- `bnp03.html` - строка 82
- `bnp04.html` - строка 107
- `bnp05.html` - строка 87
- `bnp06.html` - строка 81
- `bnp07.html` - строка 96
- `bnp08.html` - строка 119
- `bnp09.html` - строка 69
- `bnp10.html` - строка 60
- `bnp11.html` - строка 67
- `bnp12.html` - строка 72

#### 2021 (6 файлов)
- `bnp01.html` - строка 64
- `bnp02.html` - строка 43
- `bnp05.html` - строка 85
- `bnp06.html` - строка 78
- `bnp07.html` - строка 76
- `bnp08.html` - строка 73
- `bnp09.html` - **правильное использование** (строки 8, 22)
- `bnp16.html` - **правильное использование** (2 вхождения)

---

## 2. Некорректные пути в атрибутах href

### Описание проблемы

В одном файле обнаружен некорректный путь в атрибуте `href`, где отсутствует слэш перед именем директории.

### Файл: `2015/bnp01.html`

**Строка 189**:
```html
<a href="jpg01ZhFizHim_1816-1851/.jpg"></a>
```

**Проблема**: 
- Отсутствует слэш между `jpg01` и `ZhFizHim`
- Неправильное расположение точки перед расширением `.jpg`

**Должно быть**:
```html
<a href="jpg01/ZhFizHim_1816-1851.jpg"></a>
```

**Контекст** (строки 185-190):
```html
14.<b>Журнал физической химии. .</b> -2014.-Т.88, N 11.
<span class="content-link">Содержание</span>
<span class="content">
  <a href="jpg01/ZhFizHim_1637-1805.jpg"></a>
  <a href="jpg01ZhFizHim_1816-1851/.jpg"></a>
</span>
```

---

## 3. Пустые теги

### Описание проблемы

Обнаружен пустой тег `<b></b>` без содержимого, который не несет смысловой нагрузки.

### Файл: `2025/bnp01.html`

**Строка 30**:
```html
<b><a href="https://icp-ras.ru/wp-content/uploads/DISS/Kleinikova/Dissert_Kleinikova.pdf"> «Электроокисление алифатических спиртов (метанол, этанол) и альдегидов на наночастицах благородных металлов». </a></b><b></b> Диссертация на соискание ученой степени кандидата химических наук: 1.4.6. - Электрохимия. Черноголовка, 2024.
```

**Проблема**: Пустой тег `<b></b>` между закрывающим тегом `</b>` и текстом "Диссертация".

**Должно быть**:
```html
<b><a href="...">...</a></b> Диссертация на соискание ученой степени кандидата химических наук...
```

---

## 4. Некорректный закрывающий тег `</br>`

### Описание проблемы

Использован закрывающий тег `</br>`, который не является валидным HTML. Тег `<br>` является самозакрывающимся и не должен иметь закрывающего тега.

### Файл: `2025/bnp01.html`

**Строка 39**:
```html
<b><a href="https://icp-ras.ru/wp-content/uploads/DISS/Salimova/Dissert_Salimova.pdf"> «Ti-Катализируемое гомо- и кросс-цикломагнирование 1,2-диенов в синтезе природных и синтетических nZ,(n+4)Z-диеновых кислот - ингибиторов топоизомераз I и II». </a></b></br> Диссертация на соискание ученой степени кандидата химических наук: 1.4.3. - Органическая химия. 1.4.16. - Медицинская химия. Черноголовка, 2024.
```

**Проблема**: Использован `</br>` вместо самозакрывающегося тега.

**Должно быть**:
```html
</a></b><br> Диссертация...
```
или
```html
</a></b><br/> Диссертация...
```

---

## 5. URL с некорректным кодированием пробелов

### Описание проблемы

В нескольких местах URL начинаются с `%20` (закодированный пробел) вместо правильного URL. Это делает ссылки некорректными.

### Файл: `2025/bnp01.html`

**Всего проблемных URL**: 9 случаев

#### Список проблемных строк:

1. **Строка 7**: 
   ```html
   <a href="%20https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2280669">
   ```

2. **Строка 8**: 
   ```html
   <a href="%20https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2286836">
   ```

3. **Строка 9**: 
   ```html
   <a href="%20https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2289034">
   ```

4. **Строка 10**: 
   ```html
   <a href="%20https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2275948">
   ```

5. **Строка 11**: 
   ```html
   <a href="%20https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2287718">
   ```

6. **Строка 12** (двойной пробел): 
   ```html
   <a href="%20%20https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2280793">
   ```

7. **Строка 13**: 
   ```html
   <a href="%20https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2288754">
   ```

8. **Строка 14**: 
   ```html
   <a href="%20https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2275803">
   ```

9. **Строка 16**: 
   ```html
   <a href="%20https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2289521">
   ```

**Исправление**: Все `%20` в начале URL должны быть удалены:
```html
<a href="https://koha.benran.ru/cgi-bin/koha/opac-detail.pl?biblionumber=2280669">
```

---

## Статистика по годам

| Год | Файлов с `</font>` | Другие проблемы | Всего файлов |
|-----|-------------------|----------------|--------------|
| 2012 | 47 | 0 | 47 |
| 2013 | 40 | 0 | 40 |
| 2014 | 29 | 0 | 29 |
| 2015 | 26 | 1 (некорректный путь) | 27 |
| 2016 | 25 | 0 | 25 |
| 2017 | 24 | 0 | 24 |
| 2018 | 27 | 0 | 27 |
| 2019 | 24 | 0 | 24 |
| 2020 | 13 | 0 | 13 |
| 2021 | 5 | 0 | 18 (1 правильный) |
| 2022 | 0 | 0 | 12 |
| 2023 | 0 | 0 | 12 |
| 2024 | 0 | 0 | 12 |
| 2025 | 0 | 3 (пустой тег, `</br>`, URL) | 10 |

**Итого**: 249 файлов с проблемой `</font>`, 4 файла с другими проблемами

---

## Рекомендации для конвертации в Markdown

### 1. Обработка закрывающих тегов `</font>`

**Перед конвертацией** необходимо удалить все закрывающие теги `</font>`, которые не имеют парных открывающих тегов.

**Стратегия**:
- Проверить наличие открывающего тега `<font` в файле
- Если открывающего тега нет, удалить все `</font>` из конца файла
- Если открывающий тег есть, убедиться в правильной структуре вложенности

**Регулярное выражение для поиска**:
```regex
</font>$
```

### 2. Исправление некорректных путей

**Файл**: `2015/bnp01.html`, строка 189

**Исправление**:
```html
<!-- Было -->
<a href="jpg01ZhFizHim_1816-1851/.jpg"></a>

<!-- Должно быть -->
<a href="jpg01/ZhFizHim_1816-1851.jpg"></a>
```

### 3. Удаление пустых тегов

**Файл**: `2025/bnp01.html`, строка 30

**Исправление**:
```html
<!-- Было -->
</b><b></b> Диссертация...

<!-- Должно быть -->
</b> Диссертация...
```

### 4. Исправление тега `<br>`

**Файл**: `2025/bnp01.html`, строка 39

**Исправление**:
```html
<!-- Было -->
</b></br> Диссертация...

<!-- Должно быть -->
</b><br> Диссертация...
```
или
```html
</b><br/> Диссертация...
```

### 5. Исправление URL с `%20`

**Файл**: `2025/bnp01.html`, строки 7, 8, 9, 10, 11, 12, 13, 14, 16

**Исправление**:
```html
<!-- Было -->
<a href="%20https://koha.benran.ru/...">

<!-- Должно быть -->
<a href="https://koha.benran.ru/...">
```

**Регулярное выражение для поиска**:
```regex
href="%20+https://
```

**Замена на**:
```
href="https://
```

### 6. Общие рекомендации

1. **Валидация HTML**: Перед конвертацией рекомендуется проверить все файлы валидатором HTML
2. **Автоматизация**: Создать скрипт для массового исправления типичных проблем
3. **Резервные копии**: Сохранить резервные копии перед массовыми изменениями
4. **Тестирование**: После исправлений проверить корректность ссылок и отображения

---

## Приоритет исправлений

1. **Высокий приоритет**:
   - Удаление закрывающих тегов `</font>` без открывающих (249 файлов)
   - Исправление URL с `%20` (1 файл, 9 случаев)

2. **Средний приоритет**:
   - Исправление некорректного пути в `2015/bnp01.html`
   - Исправление тега `</br>` в `2025/bnp01.html`

3. **Низкий приоритет**:
   - Удаление пустого тега `<b></b>` в `2025/bnp01.html` (не влияет на функциональность, но улучшает чистоту кода)

---

## Дополнительные замечания

1. **Файлы с правильной разметкой**: 
   - `2021/bnp09.html` - содержит правильно закрытые теги `<font color=maroon>...</font>`
   - `2021/bnp16.html` - содержит правильные теги `<font>`

2. **Файлы без проблем**: 
   - Все файлы в директориях 2022, 2023, 2024 не содержат проблем с тегами `</font>`
   - Большинство файлов 2025 также не содержат проблем с `</font>`

3. **Структура файлов**: 
   - Большинство файлов имеют простую структуру с тегами `<b>`, `<a>`, `<span>`
   - Использование классов CSS (`class="content-link"`, `class="content"`) корректно

---

## Заключение

Основная проблема - это наличие закрывающих тегов `</font>` без открывающих тегов в 249 файлах (2012-2021 годы). Эта проблема не критична для отображения в браузере, но может вызвать проблемы при конвертации в Markdown или валидации HTML.

Другие проблемы (некорректные пути, пустые теги, неправильные URL) встречаются редко и локализованы в отдельных файлах, но также требуют исправления перед конвертацией.

Рекомендуется выполнить массовое исправление перед конвертацией HTML в Markdown для обеспечения корректности и чистоты разметки.

---

## Перекодировка LEGACY_BNP в UTF‑8

Для устранения предупреждений tidy вида `invalid character code` и приведения всех файлов к единой кодировке рекомендуется перекодировать все HTML-файлы в `pages/LEGACY_BNP/` в `utf-8` без BOM.

Шаги:

- Определить исходную кодировку выборки файлов с помощью скрипта `scripts/detect-encoding.ts`, запустив `yarn legacy-bnp:detect-encoding`.
- Убедиться, что в `scripts/reencode-legacy-bnp.ts` в константе `SOURCE_ENCODING` указана обнаруженная кодировка (ожидается `windows-1251` или близкая).
- Выполнить пробный прогон без записи изменений: `yarn legacy-bnp:reencode --dry-run`.
- Выполнить реальную перекодировку с созданием `.bak`-копий исходных файлов: `yarn legacy-bnp:reencode`.
- Проверить результат через tidy для нескольких файлов, например:
  - `tidy -config .tidyrc -errors -f tidy-2012-bnp01.log pages/LEGACY_BNP/2012/bnp01.html`
  - Убедиться, что предупреждения `invalid character code` исчезли и текст (особенно кириллица) отображается корректно.
